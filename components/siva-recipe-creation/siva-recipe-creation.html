<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->


<!--
An element providing a solution to no problem in particular.

Example:

    <siva-recipe-creation></siva-recipe-creation>

@demo
-->

<dom-module id="siva-recipe-creation1">
  <style>
    :host {
      margin:30px;
      display: block;
      box-sizing: border-box;
    }
    :host paper-dropdown{display:inline;}
    :host paper-dropdown .paper-input { font-size:10px; }

    :host paper-button.green {
      background-color: var(--paper-green-500);
      color: white;
    }
    :host table tr td:first-child{width:500px !important;}
  </style>
  <template >
        <iron-ajax
          id="ajax"
            auto
            url="/data/core"
            handle-as="json"
            last-response="{{nutritives}}"
            on-response="initData"
            debounce-duration="300"></iron-ajax>



    <table><tr valign="top"><td>
      <!-- <h1> Create new Recipe Data </h1> -->
    <form is="iron-form" id="form" method="post" action="/form/handler">
      <paper-input id="recipeName" label="What is the Recipe Name" required auto-validate error-message="Name shouldn't be empty" value="{{recipeName}}"></paper-input>

        <div id="mealType1">
          <h4>Meal Type</h4>
          <paper-checkbox>Breakfast</paper-checkbox>
          <paper-checkbox>Lunch</paper-checkbox>
          <paper-checkbox>Dinner</paper-checkbox>
          <paper-checkbox>Desert</paper-checkbox>
          <paper-checkbox>Side Dish</paper-checkbox>
          <paper-checkbox>Sweet</paper-checkbox>
          <paper-checkbox>Drink</paper-checkbox>
        </div>
        <div id="diseaseFriendly1">
          <h4>Friendly for deseases</h4>
          <paper-checkbox>Diabetes</paper-checkbox>
          <paper-checkbox>Hypertension</paper-checkbox>
          <paper-checkbox>Cholesterol</paper-checkbox>
        </div>
        
        <div class="horizontal">
        <paper-dropdown-menu id="foodType" label="Food Type ?" value="{{foodType}}">
          <paper-listbox class="dropdown-content">
            <paper-item>Vegetarian</paper-item>
            <paper-item>Non Vegetarian</paper-item>
            <paper-item>Contains Egg only</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-dropdown-menu id="cuisine" label="Cuisine ?" value="{{cuisine}}">
          <paper-listbox class="dropdown-content">
            <paper-item>Maharastra</paper-item>
            <paper-item>Karnataka</paper-item>
            <paper-item>Gujarati</paper-item>
            <paper-item>West Bengal</paper-item>
            <paper-item>Andhra Pradesh</paper-item>
            <paper-item>Telangana</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-dropdown-menu id="servingUnit" label="Serving Unit ?" value="{{servingUnit}}">
          <paper-listbox class="dropdown-content">
            <paper-item>1 cup</paper-item>
            <paper-item>1 bowl</paper-item>
            <paper-item>1 glass</paper-item>
            <paper-item>1 Tablespoon</paper-item>
            <paper-item>1 piece</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-dropdown-menu id="giIndex" label="GI-Index" value="{{giIndex}}">
          <paper-listbox class="dropdown-content">
            <paper-item>Low</paper-item>
            <paper-item>Medium</paper-item>
            <paper-item>High</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>

      <paper-card class="ingredient" heading="Add Ingredient" elevation="2">
      <div class="layout horizontal">
        <vaadin-combo-box id="ingredientsInputCombo" label="Add Ingredients" items="{{ingredientNames}}" ></vaadin-combo-box>

        <paper-dropdown-menu id="uom" label="U_O_M ?" value="{{currentIngredient.uom}}">
          <paper-listbox class="dropdown-content">
            <paper-item>ml</paper-item>
            <paper-item>mg</paper-item>
            <paper-item>gm</paper-item>
            <paper-item>Âµg</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-input id="recipeQuantities" type="number" label="Quantity" value="{{currentIngredient.qty}}" >
        </paper-input>
        <paper-fab icon="add" on-click="addIngredient" title="Add this ingredient"></paper-fab>
        </div>

      </paper-card>
    </form>
    </td>
    <td><h1>&nbsp;</h1><h1>&nbsp;</h1>
      <siva-compact-table data="{{recipeIngredients}}" nutritives="{{nutritives}}"></siva-compact-table>
    </td></tr></table>  

      <br/><br/>
      <paper-button raised class="green" on-click="addRecipe">Save Recipe Data</paper-button>
      <paper-card image="public/images/bbread.png" hidden>
        <file-upload target="/data/recipeImageUpload" droppable="true" raised="true" multi="true" accept="image/*">Choose File</file-upload>
      </paper-card>

      <paper-toast id="toast" text="">
        <paper-button onclick="toast.toggle()" class="yellow-button">Okay !</paper-button>
      </paper-toast>
  </template>
</dom-module>

<script>
Polymer({

  is: 'siva-recipe-creation1',
  properties: {
    recipeName: {
      type: String
    },
    nutritives: {
      type: Object,
      notify: true
    },
    ingredientNames: {
      type: Array
    },
    recipeIngredients: {
      type: Array,
      value: [],
      notify: true
    },
    currentCounts: {
      type: Object,
      value: {},
      notify: true
    },
    recipeCount: {
      type: Number,
      notify: true
    },
    exerciseCount: {
      type: Number,
      notify: true
    },
    currentIngredient: {
      type: Object,
      value: function() {
        return {
          qty: "",
          uom: "",
          servingsPerOnePerson: 1
        };
      }
    },

  },

  openSignoutDialog: function(e) {
    this.$.signOutDialog.open();
  },
  signout: function(e) {
    delete localStorage.loggedIn;
    location.reload();
  },

  initData: function(e) {
    this.ingredientNames = _.pluck(e.detail.response, "NAME")
  },
  ready: function() {
    // `ready` is called after all elements have been configured, but
    // propagates bottom-up. This element's children are ready, but parents
    // are not.
    //
    // This is the point where you should make modifications to the DOM (when
    // necessary), or kick off any processes the element wants to perform.
    console.log(this.nutritives$);
  },

  attached: function() {
    // `attached` fires once the element and its parents have been inserted
    // into a document.
    //
    // This is a good place to perform any work related to your element's
    // visual state or active behavior (measuring sizes, beginning animations,
    // loading resources, etc).
    console.log(this.nutritives);
  },

  detached: function() {
    // The analog to `attached`, `detached` fires when the element has been
    // removed from a document.
    //
    // Use this to clean up anything you did in `attached`.
  },

  addIngredient: function(e) {
    var that = this;
    if (this.recipeIngredients.length > 0) this.pop('recipeIngredients');
    // this.currentIngredient = this.currentIngredient || {};
    _.extend(this.currentIngredient, _.find(this.nutritives, function(x) {
      return x.NAME == that.$.ingredientsInputCombo.value;
    }));
    //  Calculate micro and macro nutrient values according to the current quantity
    //  The base nutritional values shared from doctors in the form of excel sheets
    //  are per 100 gm of an ingredient
    if (this.currentIngredient.qty > 0) {
      var tmpCurrentIngredient = {};
      _.extend(tmpCurrentIngredient, this.currentIngredient);
      for (k in this.currentIngredient) {
        if (k == "NAME" || k == "qty" || k == "uom" || k == "servingsPerOnePerson") continue;
        tmpCurrentIngredient[k] = tmpCurrentIngredient[k] * tmpCurrentIngredient.qty / 100;
        tmpCurrentIngredient[k] = Math.round(tmpCurrentIngredient[k] * 100) / 100;
      }
      this.push('recipeIngredients', tmpCurrentIngredient);
      this.updateTotals();
    }
  },

  updateTotals: function() {
    //  This is overhead as polymer only supports data watching on arrays (push, pop etc.)
    //  The actual totals object is the totalsObject below this line
    var totalsObject = {}
    var tmpCurrentIngredient = this.recipeIngredients[0];
    for (k in tmpCurrentIngredient) {
      if (k == "NAME" || k == "qty" || k == "uom" || k == "servingsPerOnePerson") continue;
      var x = _.pluck(this.recipeIngredients, k);
      totalsObject[k] = x.reduce((a, b) => a + b);
      totalsObject[k] = Math.round(totalsObject[k] * 100) / 100;
    }
    totalsObject.NAME = "Totals :";
    this.push('recipeIngredients', totalsObject);
  },

  addRecipe: function(e) {
    var recipe = {};

    recipe.name = this.recipeName;
    recipe.ingredients = this.recipeIngredients;

    recipe.createdBy = JSON.parse(localStorage.user).username;
    console.log(recipe);
    var xhr = new XMLHttpRequest();
    var that = this;

    xhr.onload = function(res) {
      console.log(xhr.statusCode, res.statusCode, res, xhr.response);
      if (res.currentTarget.readyState == 4) {
        that.$.toast.text = xhr.response;
        that.$.toast.open();
        that.$.form.reset();
        that.recipeIngredients = [];

        _.extend(that.currentCounts, JSON.parse(xhr.response));
        var counts = JSON.parse(xhr.response);
        that.recipeCount = counts.Recipe;

      }
    };
    xhr.open("POST", '/crud/Recipe');
    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    if (!this.$.recipeName.invalid) {
      xhr.send(JSON.stringify(recipe));
    }
  }
}); 
</script>
